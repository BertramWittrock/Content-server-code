<!DOCTYPE html>
<html lang="en">
<head>
    <title>Reaktionsdemo</title>
    <link rel="stylesheet" type="text/css" href="style.css">

    <script src="http://localhost:3000/socket.io/socket.io.js"></script>
    <script>
        var socket = io();

        // Funktion til at sende reaktioner
        function sendReaction(reactionType, noteId) {
            var reactionTypeStr = 'reaction' + reactionType;
            socket.emit('postReaction', { noteId: noteId, reactionType: reactionTypeStr });
        }

        function onNoteClick(noteId) {
        // Fjerner aktiv klasse fra alle noter
            // document.querySelectorAll('.sticky-note').forEach(note => note.classList.remove('active-note'));
            document.querySelectorAll('.sticky-note').forEach(note => {
                note.classList.remove('active-note');
                const noteId = note.getAttribute('id').split('-')[1];
                fetchCommentsForNote(noteId); // Opdater kommentarer for hver note
                // adjustNoteHeight(noteId); // Juster højden efter at have vist alle kommentarer
            });

            // Gør den valgte note større og fremhæver den
            var noteElement = document.getElementById('note-' + noteId);
            noteElement.classList.add('active-note');

            fetchCommentsForNote(noteId, true);
            // adjustNoteHeight(noteId); // Juster højden efter at have vist alle kommentarer

            // Håndterer klik uden for den aktive note
            window.addEventListener('click', function(event) {
                if (!noteElement.contains(event.target)) {
                    noteElement.classList.remove('active-note');
                    const noteId = noteElement.getAttribute('id').split('-')[1];
                    fetchCommentsForNote(noteId); // Opdater kommentarer for hver note
                    // adjustNoteHeight(noteId); // Juster højden efter at have vist alle kommentarer

                }
            });
        }

        function sendComment(noteId) {
            var commentInput = document.getElementById('comment-input-' + noteId);
            var comment = commentInput.value.trim();
            var username = 'Bruger'; // Sæt det til den aktuelle brugers navn

            if (comment) {
                // Brug Socket.IO til at sende kommentaren
                socket.emit('postComment', { noteId, username, comment });
                commentInput.value = ''; // Ryd inputfeltet
            }
        }
                
        window.onload = function() {
            fetch('/sticky-notes')
                .then(response => response.text())
                .then(html => {
                    document.getElementById('notesContainer').innerHTML = html;

                    // Hent kommentarer for hver note
                    document.querySelectorAll('.sticky-note').forEach(note => {
                        const noteId = note.getAttribute('id').split('-')[1];
                        fetchCommentsForNote(noteId);
                    });
                })
                .catch(error => console.error('Fejl ved hentning af sticky notes:', error));
        };

        // Funktion til at hente og vise kommentarer for en bestemt note
        function fetchCommentsForNote(noteId, showAll = false) {
            fetch(`/comments/${noteId}`)
                .then(response => response.json())
                .then(comments => {
                    var noteElement = document.getElementById('note-' + noteId);
                    var commentsContainer = noteElement.querySelector('.comments-container');
                    if (commentsContainer) {
                        commentsContainer.innerHTML = ''; // Ryd eksisterende kommentarer først
                        comments.forEach((comment, index) => {
                            if (showAll || index === 0) { // Vis kun første kommentar, medmindre showAll er true
                                var commentElement = document.createElement('div');
                                commentElement.classList.add('comment');
                                commentElement.innerHTML = `
                                    <strong>${comment.username}</strong>: ${comment.comment}
                                    <br/>
                                    <small>${comment.timestamp}</small>
                                `;
                                commentsContainer.appendChild(commentElement);
                            }
                        });
                        if (noteElement.classList.contains('active-note')) {
                            adjustNoteHeight(noteId);
                        } else {
                            noteElement.style.height = '250px'; // Sæt tilbage til standardhøjden
                        }
                    }
                })
                .catch(error => console.error('Fejl ved hentning af kommentarer:', error));
        }

        function adjustNoteHeight(noteId) {
            var noteElement = document.getElementById('note-' + noteId);
            if (noteElement) {
                var textElements = noteElement.querySelectorAll('.note-text');
                var totalTextHeight = Array.from(textElements).reduce((total, elem) => total + elem.offsetHeight, 0) +50;

                var commentsContainer = noteElement.querySelector('.comments-container');
                var commentInputHeight = document.getElementById('comment-input-' + noteId).offsetHeight;

                var newHeight = totalTextHeight + commentsContainer.offsetHeight + commentInputHeight + 100; // 100 er et ekstra buffer
                newHeight = Math.max(newHeight, 250); // Sørg for at minimumshøjden er 250px

                noteElement.style.height = newHeight + 'px';
            }
        }


        // Lyt til opdateringer af reaktioner
        socket.on('updateReactions', function(data) {
            var noteElement = document.getElementById('note-' + data.id);
            if (noteElement) {
                noteElement.querySelector('.note-reactions').innerHTML = `
                    <button onclick="sendReaction(1, ${data.id})"> <3 (${data.reaction1})</button>
                    <button onclick="sendReaction(2, ${data.id})"> :) (${data.reaction2})</button>
                    <button onclick="sendReaction(3, ${data.id})"> :| (${data.reaction3})</button>
                    <button onclick="sendReaction(4, ${data.id})"> :( (${data.reaction4})</button>
                `;
            }
            // Opdater UI med den nye reaktion
        

        });

        socket.on('newComment', function(comment) {
            console.log("first comment")
        // Find den note, som kommentaren hører til
            var noteElement = document.getElementById('note-' + comment.noteId);

            if (noteElement) {
                // Antager, at der er et element til kommentarer inden i hver note
                var commentsContainer = noteElement.querySelector('.comments-container');

                if (commentsContainer) {
                    // Opret et nyt element til at vise kommentaren
                    var commentElement = document.createElement('div');
                    commentElement.classList.add('comment');
                    commentElement.innerHTML = `
                        <strong>${comment.username}</strong>: ${comment.comment}
                        <br/>
                        <small>${comment.timestamp}</small>
                    `;

                    // Tilføj den nye kommentar til kommentarcontaineren
                    commentsContainer.appendChild(commentElement);

                    // Juster højden af den aktive note hvis den er åben
                    if (noteElement.classList.contains('active-note')) {
                        adjustNoteHeight(comment.noteId);
                    }
                }
            }
        });
    </script>
</head>
<body>
    <div id="overlay" class="overlay"></div>

    <div id="notesContainer"></div> <!-- Container til sticky notes -->
</body>
</html>
